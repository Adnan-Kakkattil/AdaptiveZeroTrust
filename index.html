<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Zero Trust Access Control System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap");

        :root {
            --panel: rgba(15, 23, 42, 0.62);
            --panel-border: rgba(148, 163, 184, 0.18);
            --soft: #94a3b8;
            --good: #22c55e;
            --warn: #f59e0b;
            --bad: #f43f5e;
        }

        body {
            font-family: "Inter", sans-serif;
            color: #e2e8f0;
            background: radial-gradient(circle at 20% 10%, #1e293b 0%, #0f172a 50%, #020617 100%);
            min-height: 100vh;
        }

        .glass {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            box-shadow: 0 10px 40px rgba(2, 6, 23, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .mono {
            font-family: "JetBrains Mono", monospace;
        }

        .risk-chip {
            padding: 0.18rem 0.56rem;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.07em;
        }

        .risk-allow {
            color: #86efac;
            background: rgba(34, 197, 94, 0.15);
        }

        .risk-step {
            color: #fcd34d;
            background: rgba(245, 158, 11, 0.17);
        }

        .risk-revoke {
            color: #fda4af;
            background: rgba(244, 63, 94, 0.2);
        }

        .status-pulse {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 9999px;
            background: #22c55e;
        }

        .status-pulse::after {
            content: "";
            position: absolute;
            inset: -5px;
            border-radius: 9999px;
            border: 2px solid rgba(74, 222, 128, 0.45);
            animation: ping 1.6s infinite;
        }

        @keyframes ping {
            0% { transform: scale(0.7); opacity: 1; }
            80%, 100% { transform: scale(1.35); opacity: 0; }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.35);
            border-radius: 9999px;
        }
    </style>
</head>
<body class="px-4 md:px-8 py-6 md:py-8">
    <div class="max-w-[1400px] mx-auto space-y-6">
        <header class="glass rounded-2xl px-5 md:px-7 py-4 md:py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="flex items-center gap-4">
                <div class="w-11 h-11 rounded-xl bg-cyan-500/20 border border-cyan-300/30 flex items-center justify-center text-cyan-200">
                    <i class="fa-solid fa-shield-halved text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-semibold tracking-tight">Adaptive Zero Trust Access Control System</h1>
                    <p class="text-xs md:text-sm text-slate-300/90">Continuous User Verification | Python + SQLite Policy Engine</p>
                </div>
            </div>
            <div class="flex items-center flex-wrap gap-3 text-xs">
                <div id="operator-badge" class="hidden px-3 py-2 rounded-lg bg-cyan-500/15 border border-cyan-300/20 text-cyan-100"></div>
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-500/15 border border-emerald-300/20">
                    <span class="status-pulse"></span>
                    <span class="font-semibold text-emerald-200">Stream Active</span>
                </div>
                <a id="export-btn" href="/api/v1/audit/export.csv" class="px-4 py-2 rounded-lg bg-indigo-500/20 text-indigo-100 border border-indigo-300/30 hover:bg-indigo-500/30 transition">
                    <i class="fa-solid fa-file-arrow-down mr-2"></i>Export Audit CSV
                </a>
                <button id="inject-btn" class="px-4 py-2 rounded-lg bg-rose-500/20 text-rose-200 border border-rose-300/30 hover:bg-rose-500/30 transition">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>Inject Anomalous Pattern
                </button>
                <button id="logout-btn" class="px-4 py-2 rounded-lg bg-slate-500/20 text-slate-100 border border-slate-300/20 hover:bg-slate-500/30 transition">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
                </button>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4">
            <article class="glass rounded-xl p-4">
                <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">Active Identities</p>
                <p id="metric-active" class="text-3xl font-semibold mt-2">0</p>
            </article>
            <article class="glass rounded-xl p-4">
                <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">Global Trust Index</p>
                <p class="text-3xl font-semibold mt-2"><span id="metric-trust">0.0</span><span class="text-base text-slate-400"> / 100</span></p>
            </article>
            <article class="glass rounded-xl p-4">
                <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">Revoked Sessions</p>
                <p id="metric-revoke" class="text-3xl font-semibold mt-2 text-rose-300">0</p>
            </article>
            <article class="glass rounded-xl p-4">
                <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">Step-Up Challenges</p>
                <p id="metric-step" class="text-3xl font-semibold mt-2 text-amber-300">0</p>
            </article>
            <article class="glass rounded-xl p-4">
                <p class="text-[11px] uppercase tracking-[0.18em] text-slate-400">Allowed Sessions</p>
                <p id="metric-allow" class="text-3xl font-semibold mt-2 text-emerald-300">0</p>
            </article>
        </section>

        <section id="status-banner" class="glass rounded-xl px-4 py-3 text-sm hidden"></section>

        <section class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <div class="xl:col-span-3 glass rounded-2xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-400/20 flex justify-between items-center">
                    <h2 class="font-semibold tracking-tight text-sm md:text-base">Real-Time Continuous Verification Feed</h2>
                    <span class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Who + Where + When + What</span>
                </div>
                <div class="overflow-auto">
                    <table class="w-full text-sm">
                        <thead class="text-[11px] uppercase tracking-[0.14em] text-slate-400 border-b border-slate-500/25">
                            <tr>
                                <th class="text-left px-4 py-3">Identity</th>
                                <th class="text-left px-4 py-3">Location / Context</th>
                                <th class="text-left px-4 py-3">Device + Behavior</th>
                                <th class="text-left px-4 py-3">Trust Score</th>
                                <th class="text-left px-4 py-3">Policy Decision</th>
                            </tr>
                        </thead>
                        <tbody id="verification-table-body" class="divide-y divide-slate-700/40"></tbody>
                    </table>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass rounded-2xl p-5">
                    <h3 class="text-sm font-semibold mb-3">Identity Detail</h3>
                    <div id="identity-detail" class="space-y-2 text-sm text-slate-200"></div>
                </div>

                <div class="glass rounded-2xl p-5">
                    <h3 class="text-sm font-semibold mb-4">Policy Editor (Role-Based)</h3>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <label class="block">
                            <span class="text-slate-300">Location Weight</span>
                            <input id="policy-location-weight" type="number" min="0" step="0.01" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                        </label>
                        <label class="block">
                            <span class="text-slate-300">Device Weight</span>
                            <input id="policy-device-weight" type="number" min="0" step="0.01" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                        </label>
                        <label class="block">
                            <span class="text-slate-300">Behavior Weight</span>
                            <input id="policy-behavior-weight" type="number" min="0" step="0.01" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                        </label>
                        <label class="block">
                            <span class="text-slate-300">Revoke Threshold</span>
                            <input id="policy-revoke-threshold" type="number" min="0" max="100" step="1" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                        </label>
                        <label class="block col-span-2">
                            <span class="text-slate-300">Step-Up Threshold</span>
                            <input id="policy-step-threshold" type="number" min="0" max="100" step="1" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                        </label>
                    </div>
                    <div class="mt-3 flex items-center justify-between gap-3">
                        <p id="policy-note" class="text-[11px] text-slate-400">Admins can update live policy values.</p>
                        <button id="save-policy-btn" class="px-3 py-2 rounded-lg bg-cyan-500/25 border border-cyan-300/25 text-cyan-100 hover:bg-cyan-500/35 transition text-xs">
                            Save Policy
                        </button>
                    </div>
                </div>

                <div class="glass rounded-2xl p-5">
                    <h3 class="text-sm font-semibold mb-4">Least Privilege Guardrails</h3>
                    <div class="space-y-2 text-xs">
                        <div class="px-3 py-2 rounded-lg bg-emerald-500/10 border border-emerald-300/20 flex justify-between">
                            <span><i class="fa-solid fa-check mr-2"></i>Geo-Velocity Monitoring</span><span class="text-emerald-200">ON</span>
                        </div>
                        <div class="px-3 py-2 rounded-lg bg-emerald-500/10 border border-emerald-300/20 flex justify-between">
                            <span><i class="fa-solid fa-check mr-2"></i>Adaptive MFA Escalation</span><span class="text-emerald-200">ON</span>
                        </div>
                        <div class="px-3 py-2 rounded-lg bg-amber-500/10 border border-amber-300/20 flex justify-between">
                            <span><i class="fa-solid fa-triangle-exclamation mr-2"></i>Device Drift Detection</span><span class="text-amber-200">WARN</span>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-2xl p-5">
                    <h3 class="text-sm font-semibold mb-3">Policy Engine Simulation Logs</h3>
                    <div id="log-container" class="mono text-[12px] h-72 overflow-y-auto space-y-2 text-slate-300/90"></div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <div class="glass rounded-2xl p-5">
                <div class="flex items-center justify-between gap-3 mb-3">
                    <h3 class="text-sm font-semibold">Audit Event History</h3>
                    <div class="flex items-center gap-2 text-xs">
                        <select id="audit-severity" class="px-2 py-1 rounded bg-slate-800/70 border border-slate-600">
                            <option value="">All severity</option>
                            <option value="INFO">INFO</option>
                            <option value="WARN">WARN</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                        <button id="audit-refresh-btn" class="px-2 py-1 rounded bg-slate-700/70 border border-slate-500">Apply</button>
                    </div>
                </div>
                <div id="audit-list" class="mono text-[12px] h-72 overflow-y-auto space-y-2 text-slate-300/90"></div>
                <div class="mt-3 flex items-center justify-between text-xs">
                    <button id="audit-prev" class="px-2 py-1 rounded bg-slate-700/70 border border-slate-500">Prev</button>
                    <span id="audit-page-label" class="text-slate-400">Page 1</span>
                    <button id="audit-next" class="px-2 py-1 rounded bg-slate-700/70 border border-slate-500">Next</button>
                </div>
            </div>

            <div class="glass rounded-2xl p-5">
                <div class="flex items-center justify-between gap-3 mb-3">
                    <h3 class="text-sm font-semibold">Policy Decision History</h3>
                    <div class="flex items-center gap-2 text-xs">
                        <select id="decision-filter" class="px-2 py-1 rounded bg-slate-800/70 border border-slate-600">
                            <option value="">All decisions</option>
                            <option value="ALLOW">ALLOW</option>
                            <option value="STEP_UP">STEP_UP</option>
                            <option value="REVOKE">REVOKE</option>
                        </select>
                        <button id="decision-refresh-btn" class="px-2 py-1 rounded bg-slate-700/70 border border-slate-500">Apply</button>
                    </div>
                </div>
                <div id="decision-list" class="mono text-[12px] h-72 overflow-y-auto space-y-2 text-slate-300/90"></div>
                <div class="mt-3 flex items-center justify-between text-xs">
                    <button id="decision-prev" class="px-2 py-1 rounded bg-slate-700/70 border border-slate-500">Prev</button>
                    <span id="decision-page-label" class="text-slate-400">Page 1</span>
                    <button id="decision-next" class="px-2 py-1 rounded bg-slate-700/70 border border-slate-500">Next</button>
                </div>
            </div>
        </section>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-slate-950/75 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="glass rounded-2xl max-w-md w-full p-6 border border-rose-300/25">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-14 h-14 rounded-full bg-rose-500/25 border border-rose-300/25 flex items-center justify-center text-rose-200">
                    <i class="fa-solid fa-user-lock text-2xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold">Critical Policy Enforcement</h4>
                    <p class="text-sm text-slate-300">Access automatically revoked</p>
                </div>
            </div>
            <p class="text-sm text-slate-200 mb-5">
                An anomalous access pattern was detected for
                <span id="alert-user" class="font-semibold text-rose-200">Unknown User</span>.
                Least privilege policy invalidated the token and terminated the session.
            </p>
            <button id="alert-close" class="w-full py-2.5 rounded-lg bg-slate-200/15 hover:bg-slate-200/25 transition text-sm">
                Dismiss
            </button>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="glass rounded-2xl max-w-md w-full p-6 border border-cyan-200/20">
            <h2 class="text-xl font-semibold mb-2">Operator Login</h2>
            <p class="text-xs text-slate-300 mb-4">Demo users: <span class="mono">admin/admin123</span> or <span class="mono">analyst/analyst123</span></p>
            <form id="login-form" class="space-y-3">
                <label class="block text-sm">
                    Username
                    <input id="login-username" required class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                </label>
                <label class="block text-sm">
                    Password
                    <input id="login-password" type="password" required class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800/70 border border-slate-600 focus:outline-none focus:ring focus:ring-cyan-700/60">
                </label>
                <button class="w-full py-2.5 rounded-lg bg-cyan-500/30 border border-cyan-300/25 hover:bg-cyan-500/40 transition">Sign In</button>
            </form>
            <p id="login-error" class="text-rose-300 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <script>
        const elements = {
            metricActive: document.getElementById("metric-active"),
            metricTrust: document.getElementById("metric-trust"),
            metricRevoke: document.getElementById("metric-revoke"),
            metricStep: document.getElementById("metric-step"),
            metricAllow: document.getElementById("metric-allow"),
            statusBanner: document.getElementById("status-banner"),
            tbody: document.getElementById("verification-table-body"),
            logs: document.getElementById("log-container"),
            identityDetail: document.getElementById("identity-detail"),
            injectBtn: document.getElementById("inject-btn"),
            exportBtn: document.getElementById("export-btn"),
            logoutBtn: document.getElementById("logout-btn"),
            alertModal: document.getElementById("alert-modal"),
            alertUser: document.getElementById("alert-user"),
            alertClose: document.getElementById("alert-close"),
            operatorBadge: document.getElementById("operator-badge"),
            loginModal: document.getElementById("login-modal"),
            loginForm: document.getElementById("login-form"),
            loginUsername: document.getElementById("login-username"),
            loginPassword: document.getElementById("login-password"),
            loginError: document.getElementById("login-error"),
            policyLocationWeight: document.getElementById("policy-location-weight"),
            policyDeviceWeight: document.getElementById("policy-device-weight"),
            policyBehaviorWeight: document.getElementById("policy-behavior-weight"),
            policyRevokeThreshold: document.getElementById("policy-revoke-threshold"),
            policyStepThreshold: document.getElementById("policy-step-threshold"),
            savePolicyBtn: document.getElementById("save-policy-btn"),
            policyNote: document.getElementById("policy-note"),
            auditList: document.getElementById("audit-list"),
            auditSeverity: document.getElementById("audit-severity"),
            auditRefreshBtn: document.getElementById("audit-refresh-btn"),
            auditPrev: document.getElementById("audit-prev"),
            auditNext: document.getElementById("audit-next"),
            auditPageLabel: document.getElementById("audit-page-label"),
            decisionList: document.getElementById("decision-list"),
            decisionFilter: document.getElementById("decision-filter"),
            decisionRefreshBtn: document.getElementById("decision-refresh-btn"),
            decisionPrev: document.getElementById("decision-prev"),
            decisionNext: document.getElementById("decision-next"),
            decisionPageLabel: document.getElementById("decision-page-label"),
        };

        let currentUser = null;
        let pollHandle = null;
        let identities = [];
        let selectedIdentityCode = null;
        let auditPage = 1;
        let auditTotal = 0;
        let decisionPage = 1;
        let decisionTotal = 0;
        let csrfToken = null;

        function showStatus(message, level = "info") {
            elements.statusBanner.classList.remove("hidden", "text-emerald-200", "text-amber-200", "text-rose-200");
            elements.statusBanner.textContent = message;
            if (level === "error") elements.statusBanner.classList.add("text-rose-200");
            else if (level === "warn") elements.statusBanner.classList.add("text-amber-200");
            else elements.statusBanner.classList.add("text-emerald-200");
        }

        function hideStatus() {
            elements.statusBanner.classList.add("hidden");
            elements.statusBanner.textContent = "";
        }

        async function api(path, options = {}) {
            const requestOptions = { ...options, headers: { ...(options.headers || {}) } };
            if (csrfToken && ["POST", "PUT", "PATCH", "DELETE"].includes((requestOptions.method || "GET").toUpperCase())) {
                requestOptions.headers["X-CSRF-Token"] = csrfToken;
            }
            const response = await fetch(path, requestOptions);
            const payload = await response.json().catch(() => null);
            if (!payload) throw new Error("Invalid server response");

            if (response.status === 401) {
                currentUser = null;
                stopPolling();
                showLogin();
                throw new Error("Authentication required");
            }
            if (!response.ok) {
                throw new Error(payload.error?.message || "Request failed");
            }
            return payload.data;
        }

        async function apiWithRetry(path, options = {}, retries = 2) {
            let lastError = null;
            for (let attempt = 0; attempt <= retries; attempt += 1) {
                try {
                    return await api(path, options);
                } catch (error) {
                    lastError = error;
                    const isAuthError = error.message === "Authentication required";
                    if (isAuthError || attempt === retries) break;
                    const backoff = (attempt + 1) * 400;
                    await new Promise((resolve) => setTimeout(resolve, backoff));
                }
            }
            throw lastError;
        }

        function showLogin() {
            elements.loginModal.classList.remove("hidden");
            elements.loginModal.classList.add("flex");
        }

        function hideLogin() {
            elements.loginModal.classList.add("hidden");
            elements.loginModal.classList.remove("flex");
            elements.loginError.classList.add("hidden");
            elements.loginError.textContent = "";
        }

        function startPolling() {
            stopPolling();
            showStatus("Loading telemetry...");
            fetchTick();
            pollHandle = setInterval(fetchTick, 4000);
        }

        function stopPolling() {
            if (pollHandle) {
                clearInterval(pollHandle);
                pollHandle = null;
            }
        }

        function policyChipClass(state) {
            if (state === "REVOKE") return "risk-chip risk-revoke";
            if (state === "STEP_UP") return "risk-chip risk-step";
            return "risk-chip risk-allow";
        }

        function trustColor(score) {
            if (score < 45) return "text-rose-300";
            if (score < 68) return "text-amber-300";
            return "text-emerald-300";
        }

        function renderMetrics(metrics) {
            elements.metricActive.textContent = metrics.activeIdentities;
            elements.metricTrust.textContent = metrics.trustIndex;
            elements.metricRevoke.textContent = metrics.revokedSessions;
            elements.metricStep.textContent = metrics.stepUpChallenges;
            elements.metricAllow.textContent = metrics.allowedSessions;
        }

        function renderIdentityDetail() {
            const identity = identities.find((item) => item.identityCode === selectedIdentityCode);
            if (!identity) {
                elements.identityDetail.innerHTML = `<p class="text-slate-400">Select an identity from the table.</p>`;
                return;
            }
            elements.identityDetail.innerHTML = `
                <div><span class="text-slate-400">Name:</span> ${identity.name}</div>
                <div><span class="text-slate-400">Identity:</span> <span class="mono">${identity.identityCode}</span></div>
                <div><span class="text-slate-400">Role:</span> ${identity.role}</div>
                <div><span class="text-slate-400">Asset:</span> ${identity.protectedAsset}</div>
                <div><span class="text-slate-400">Context:</span> ${identity.location} / <span class="mono">${identity.ipAddress}</span></div>
                <div><span class="text-slate-400">Device:</span> ${identity.devicePosture}</div>
                <div><span class="text-slate-400">Last Seen:</span> ${identity.lastSeen.replace("T", " ")}</div>
            `;
        }

        function renderTable(users) {
            identities = users;
            if (!selectedIdentityCode && users.length > 0) selectedIdentityCode = users[0].identityCode;
            elements.tbody.innerHTML = "";
            users.forEach((user) => {
                const row = document.createElement("tr");
                const selectedClass = user.identityCode === selectedIdentityCode ? "bg-cyan-600/20" : "";
                row.className = `hover:bg-slate-700/25 transition cursor-pointer ${selectedClass}`;
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-semibold">${user.name}</div>
                        <div class="text-xs text-slate-400">${user.role} <span class="mono">(${user.identityCode})</span></div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs">${user.location}</div>
                        <div class="text-[11px] text-slate-400 mono">${user.ipAddress}</div>
                        <div class="text-[11px] text-slate-500">Seen: ${user.lastSeen.replace("T", " ")}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs">${user.devicePosture}</div>
                        <div class="text-[11px] text-slate-300/80">Behavior Score: <span class="font-semibold">${user.behaviorScore}</span></div>
                        <div class="text-[11px] text-slate-500">Asset: ${user.protectedAsset}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="mono font-semibold ${trustColor(user.trustScore)}">${user.trustScore}</div>
                        <div class="w-20 mt-1 h-1.5 rounded-full bg-slate-700/70 overflow-hidden">
                            <div class="${user.trustScore < 45 ? "bg-rose-400" : user.trustScore < 68 ? "bg-amber-400" : "bg-emerald-400"} h-full" style="width: ${user.trustScore}%"></div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="${policyChipClass(user.accessState)}">${user.accessState}</span>
                    </td>
                `;
                row.addEventListener("click", () => {
                    selectedIdentityCode = user.identityCode;
                    renderTable(identities);
                    renderIdentityDetail();
                    decisionPage = 1;
                    loadDecisionHistory();
                });
                elements.tbody.appendChild(row);
            });
            renderIdentityDetail();
        }

        function renderPolicy(policy) {
            elements.policyLocationWeight.value = policy.locationWeight;
            elements.policyDeviceWeight.value = policy.deviceWeight;
            elements.policyBehaviorWeight.value = policy.behaviorWeight;
            elements.policyRevokeThreshold.value = policy.revokeThreshold;
            elements.policyStepThreshold.value = policy.stepUpThreshold;
        }

        function setRoleView() {
            if (!currentUser) return;
            const isAdmin = currentUser.role === "admin";
            elements.operatorBadge.textContent = `${currentUser.fullName} (${currentUser.role.toUpperCase()})`;
            elements.operatorBadge.classList.remove("hidden");
            elements.injectBtn.disabled = !isAdmin;
            elements.savePolicyBtn.disabled = !isAdmin;
            elements.injectBtn.classList.toggle("opacity-40", !isAdmin);
            elements.savePolicyBtn.classList.toggle("opacity-40", !isAdmin);
            elements.policyNote.textContent = isAdmin
                ? "You are admin. Changes apply immediately to scoring."
                : "Read-only mode: only admins can modify policy.";
        }

        function severityColor(severity) {
            if (severity === "CRITICAL") return "text-rose-300";
            if (severity === "WARN") return "text-amber-300";
            return "text-cyan-300";
        }

        function renderAudit(payload) {
            auditTotal = payload.total;
            const pages = Math.max(1, Math.ceil(payload.total / payload.pageSize));
            elements.auditPageLabel.textContent = `Page ${payload.page} of ${pages}`;
            elements.auditList.innerHTML = "";
            payload.items.forEach((event) => {
                const line = document.createElement("div");
                line.className = `${severityColor(event.severity)} leading-relaxed`;
                line.innerHTML = `[${event.eventTime.replace("T", " ")}] ${event.severity} ${event.eventType} ${event.message}`;
                elements.auditList.appendChild(line);
            });
            if (!payload.items.length) elements.auditList.innerHTML = `<p class="text-slate-400">No events for current filter.</p>`;
        }

        function renderDecisions(payload) {
            decisionTotal = payload.total;
            const pages = Math.max(1, Math.ceil(payload.total / payload.pageSize));
            elements.decisionPageLabel.textContent = `Page ${payload.page} of ${pages}`;
            elements.decisionList.innerHTML = "";
            payload.items.forEach((item) => {
                const color = item.decision === "REVOKE" ? "text-rose-300" : item.decision === "STEP_UP" ? "text-amber-300" : "text-emerald-300";
                const line = document.createElement("div");
                line.className = color;
                line.innerHTML = `[${item.decisionTime.replace("T", " ")}] ${item.identityCode} ${item.decision} trust=${item.trustScore} reasons=${item.reasons.join(",")}`;
                elements.decisionList.appendChild(line);
            });
            if (!payload.items.length) elements.decisionList.innerHTML = `<p class="text-slate-400">No decisions for current filter.</p>`;
        }

        function renderLogs(events) {
            elements.logs.innerHTML = "";
            events.forEach((event) => {
                const line = document.createElement("div");
                line.className = `${severityColor(event.severity)} leading-relaxed`;
                line.innerHTML = `<span class="text-slate-500">[${event.eventTime.replace("T", " ")}]</span> <span class="font-semibold">${event.severity}</span> ${event.message}`;
                elements.logs.appendChild(line);
            });
        }

        async function fetchTick() {
            try {
                const payload = await apiWithRetry("/api/v1/dashboard/tick");
                renderMetrics(payload.metrics);
                renderTable(payload.identities);
                renderPolicy(payload.policy);
                renderLogs(payload.events);
                hideStatus();
            } catch (error) {
                showStatus(`Dashboard error: ${error.message}`, "error");
            }
        }

        async function loadAuditEvents() {
            const query = new URLSearchParams({ page: String(auditPage), pageSize: "12" });
            if (elements.auditSeverity.value) query.set("severity", elements.auditSeverity.value);
            const payload = await apiWithRetry(`/api/v1/audit/events?${query.toString()}`);
            renderAudit(payload);
        }

        async function loadDecisionHistory() {
            const query = new URLSearchParams({ page: String(decisionPage), pageSize: "12" });
            if (elements.decisionFilter.value) query.set("decision", elements.decisionFilter.value);
            if (selectedIdentityCode) query.set("identityCode", selectedIdentityCode);
            const payload = await apiWithRetry(`/api/v1/policy-decisions?${query.toString()}`);
            renderDecisions(payload);
        }

        async function injectAnomaly() {
            if (!currentUser || currentUser.role !== "admin") return;
            elements.injectBtn.disabled = true;
            elements.injectBtn.classList.add("opacity-60");
            try {
                const payload = await api("/api/v1/anomalies/inject", { method: "POST" });
                if (payload.targetUser) {
                    elements.alertUser.textContent = payload.targetUser;
                    elements.alertModal.classList.remove("hidden");
                    elements.alertModal.classList.add("flex");
                }
                await fetchTick();
                await loadAuditEvents();
                await loadDecisionHistory();
            } finally {
                elements.injectBtn.disabled = false;
                elements.injectBtn.classList.remove("opacity-60");
            }
        }

        async function savePolicy() {
            if (!currentUser || currentUser.role !== "admin") return;
            elements.savePolicyBtn.disabled = true;
            elements.savePolicyBtn.classList.add("opacity-60");
            try {
                const payload = await api("/api/v1/policy", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        locationWeight: Number(elements.policyLocationWeight.value),
                        deviceWeight: Number(elements.policyDeviceWeight.value),
                        behaviorWeight: Number(elements.policyBehaviorWeight.value),
                        revokeThreshold: Number(elements.policyRevokeThreshold.value),
                        stepUpThreshold: Number(elements.policyStepThreshold.value),
                    }),
                });
                renderPolicy(payload.policy);
                elements.policyNote.textContent = "Policy saved successfully.";
                await fetchTick();
                await loadDecisionHistory();
            } catch (error) {
                elements.policyNote.textContent = `Policy update failed: ${error.message}`;
            } finally {
                elements.savePolicyBtn.disabled = false;
                elements.savePolicyBtn.classList.remove("opacity-60");
            }
        }

        async function checkAuth() {
            try {
                const payload = await api("/api/v1/auth/me");
                if (!payload.authenticated) {
                    showStatus("Session expired. Please sign in to continue.", "warn");
                    showLogin();
                    return;
                }
                currentUser = payload.user;
                hideLogin();
                setRoleView();
                startPolling();
                await loadAuditEvents();
                await loadDecisionHistory();
            } catch (_) {
                showStatus("Authentication required.", "warn");
                showLogin();
            }
        }

        async function logout() {
            if (!currentUser) return;
            try {
                await api("/api/v1/auth/logout", { method: "POST" });
            } catch (_) {
                // Ignore logout error and still reset UI.
            }
            currentUser = null;
            elements.operatorBadge.classList.add("hidden");
            stopPolling();
            showStatus("Signed out successfully.", "info");
            showLogin();
        }

        async function loadCsrfToken() {
            const payload = await api("/api/v1/auth/csrf");
            csrfToken = payload.csrfToken;
        }

        elements.injectBtn.addEventListener("click", injectAnomaly);
        elements.savePolicyBtn.addEventListener("click", savePolicy);
        elements.logoutBtn.addEventListener("click", logout);
        elements.auditRefreshBtn.addEventListener("click", async () => {
            auditPage = 1;
            await loadAuditEvents();
        });
        elements.auditPrev.addEventListener("click", async () => {
            if (auditPage > 1) {
                auditPage -= 1;
                await loadAuditEvents();
            }
        });
        elements.auditNext.addEventListener("click", async () => {
            const pages = Math.max(1, Math.ceil(auditTotal / 12));
            if (auditPage < pages) {
                auditPage += 1;
                await loadAuditEvents();
            }
        });
        elements.decisionRefreshBtn.addEventListener("click", async () => {
            decisionPage = 1;
            await loadDecisionHistory();
        });
        elements.decisionPrev.addEventListener("click", async () => {
            if (decisionPage > 1) {
                decisionPage -= 1;
                await loadDecisionHistory();
            }
        });
        elements.decisionNext.addEventListener("click", async () => {
            const pages = Math.max(1, Math.ceil(decisionTotal / 12));
            if (decisionPage < pages) {
                decisionPage += 1;
                await loadDecisionHistory();
            }
        });
        elements.alertClose.addEventListener("click", () => {
            elements.alertModal.classList.add("hidden");
            elements.alertModal.classList.remove("flex");
        });
        elements.loginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            elements.loginError.classList.add("hidden");
            try {
                const payload = await api("/api/v1/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: elements.loginUsername.value.trim(),
                        password: elements.loginPassword.value,
                    }),
                });
                currentUser = payload.user;
                hideLogin();
                showStatus("Authenticated. Loading live telemetry...", "info");
                setRoleView();
                startPolling();
                await loadAuditEvents();
                await loadDecisionHistory();
            } catch (error) {
                elements.loginError.textContent = error.message;
                elements.loginError.classList.remove("hidden");
            }
        });
        elements.exportBtn.addEventListener("click", (event) => {
            if (!currentUser) {
                event.preventDefault();
                showLogin();
            }
        });

        loadCsrfToken().then(checkAuth).catch(() => showStatus("Unable to initialize session security.", "error"));
    </script>
</body>
</html> 